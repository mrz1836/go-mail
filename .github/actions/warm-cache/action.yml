# ------------------------------------------------------------------------------------
#  Warm Cache Composite Action (GoFortress)
#
#  Purpose: Warm Go module and build caches for efficient CI/CD execution.
#  This action handles cache restoration, warming, and saving for Go projects.
#
#  Maintainer: @mrz1836
#
# ------------------------------------------------------------------------------------

name: "Warm Go Caches"
description: "Warm Go module and build caches for the specified Go version and OS"

inputs:
  go-version:
    description: "Go version to use"
    required: true
  matrix-os:
    description: "Operating system for the runner"
    required: true
  matrix-name:
    description: "Display name for the matrix configuration"
    required: true
  enable-verbose:
    description: "Enable verbose output"
    required: false
    default: "false"
  go-primary-version:
    description: "Primary Go version for comparison"
    required: true
  go-secondary-version:
    description: "Secondary Go version for comparison"
    required: true
  env-json:
    description: "JSON string of environment variables"
    required: true
  redis-enabled:
    description: "Whether Redis caching is enabled"
    required: false
    default: "false"
  redis-versions:
    description: "Comma-separated list of Redis versions to warm"
    required: false
    default: "7-alpine"
  redis-cache-force-pull:
    description: "Whether to force pull Redis images even when cached"
    required: false
    default: "false"
  go-sum-file:
    description: "Path to go.sum file for cache key generation (single module mode)"
    required: true
  enable-multi-module:
    description: "Enable multi-module mode - uses hash of all go.sum files for cache keys"
    required: false
    default: "false"

runs:
  using: "composite"
  steps:
    # --------------------------------------------------------------------
    # Parse environment variables
    # --------------------------------------------------------------------
    - name: üîß Parse environment variables
      shell: bash
      env:
        ENV_JSON: ${{ inputs.env-json }}
      run: |
        echo "üìã Setting environment variables..."
        echo "$ENV_JSON" | jq -r 'to_entries | .[] | "\(.key)=\(.value)"' | while IFS='=' read -r key value; do
          echo "$key=$value" >> $GITHUB_ENV
        done

    # --------------------------------------------------------------------
    # Set environment variables
    # --------------------------------------------------------------------
    - name: ‚öôÔ∏è Set cache paths
      id: set-cache-env
      shell: bash
      run: |
        echo "üîß Setting up cache environment variables..."
        echo "GOCACHE=$HOME/.cache/go-build" >> $GITHUB_ENV
        echo "GOMODCACHE=$HOME/go/pkg/mod" >> $GITHUB_ENV
        echo "GOLANGCI_LINT_CACHE=$HOME/.cache/golangci-lint" >> $GITHUB_ENV
        echo "‚úÖ Cache Environment variables set successfully"

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # Setup Go with caching and version management
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    - name: üèóÔ∏è Setup Go with Cache
      id: setup-go
      uses: ./.github/actions/setup-go-with-cache
      with:
        go-version: ${{ inputs.go-version }}
        matrix-os: ${{ inputs.matrix-os }}
        go-primary-version: ${{ inputs.go-primary-version }}
        go-secondary-version: ${{ inputs.go-secondary-version }}
        go-sum-file: ${{ inputs.go-sum-file }}
        enable-multi-module: ${{ inputs.enable-multi-module }}

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # Setup MAGE-X (required for magex commands in cache warming)
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    - name: üîß Setup MAGE-X
      uses: ./.github/actions/setup-magex
      with:
        magex-version: ${{ env.MAGE_X_VERSION }}
        runner-os: ${{ inputs.matrix-os }}

    # --------------------------------------------------------------------
    # Warm Redis Docker image cache
    # --------------------------------------------------------------------
    - name: üóÑÔ∏è Warm Redis Cache
      if: inputs.redis-enabled == 'true'
      id: warm-redis
      uses: ./.github/actions/warm-redis-cache
      with:
        redis-versions: ${{ inputs.redis-versions }}
        runner-os: ${{ inputs.matrix-os }}
        force-pull: ${{ inputs.redis-cache-force-pull }}

    # --------------------------------------------------------------------
    # Extract Go module directory from GO_SUM_FILE path
    # --------------------------------------------------------------------
    - name: üîß Extract Go module directory
      id: extract-module-dir
      shell: bash
      run: |
        GO_SUM_FILE="${{ inputs.go-sum-file }}"
        GO_MODULE_DIR=$(dirname "$GO_SUM_FILE")

        # Handle root directory case (dirname returns ".")
        if [ "$GO_MODULE_DIR" = "." ]; then
          GO_MODULE_DIR=""
          echo "üìÅ Go module directory: repository root"
        else
          echo "üìÅ Go module directory: $GO_MODULE_DIR"
        fi

        # Export for subsequent steps
        echo "GO_MODULE_DIR=$GO_MODULE_DIR" >> $GITHUB_ENV
        echo "module-dir=$GO_MODULE_DIR" >> $GITHUB_OUTPUT

    # --------------------------------------------------------------------
    # Compute cache keys for saving (must match restore keys)
    # --------------------------------------------------------------------
    - name: üîë Compute cache keys for saving
      id: cache-keys
      shell: bash
      run: |
        if [ "${{ inputs.enable-multi-module }}" == "true" ]; then
          echo "üì¶ Multi-module mode - cache keys will use hash of all go.sum files"
          HASH="${{ hashFiles('**/go.sum') }}"
          echo "module-key=${{ inputs.matrix-os }}-gomod-multi-${HASH}" >> $GITHUB_OUTPUT
          echo "build-key=${{ inputs.matrix-os }}-gobuild-multi-${{ inputs.go-version }}-${HASH}" >> $GITHUB_OUTPUT
        else
          echo "üìÅ Single module mode - cache keys will use hash of ${{ inputs.go-sum-file }}"
          HASH="${{ hashFiles(inputs.go-sum-file) }}"
          echo "module-key=${{ inputs.matrix-os }}-gomod-${HASH}" >> $GITHUB_OUTPUT
          echo "build-key=${{ inputs.matrix-os }}-gobuild-${{ inputs.go-version }}-${HASH}" >> $GITHUB_OUTPUT
        fi

    # --------------------------------------------------------------------
    # Ensure go.sum exists (single-module mode only)
    # --------------------------------------------------------------------
    - name: üìã Ensure go.sum exists (single-module)
      if: ${{ inputs.enable-multi-module != 'true' }}
      shell: bash
      run: |
        GO_SUM_FILE="${{ inputs.go-sum-file }}"
        GO_MODULE_DIR="${{ env.GO_MODULE_DIR }}"

        echo "üîç Checking for go.sum file at: $GO_SUM_FILE"
        if [ ! -f "$GO_SUM_FILE" ]; then
          echo "‚ö†Ô∏è Go.sum not found at $GO_SUM_FILE, running 'magex tidy' to generate it."
          if [ -n "$GO_MODULE_DIR" ]; then
            echo "üîß Running magex tidy from directory: $GO_MODULE_DIR"
            (cd "$GO_MODULE_DIR" && magex tidy)
          else
            echo "üîß Running magex tidy from repository root"
            magex tidy
          fi
          echo "‚úÖ Go.sum generated successfully at $GO_SUM_FILE"
        else
          echo "‚úÖ Go.sum already exists at $GO_SUM_FILE"
        fi

    # --------------------------------------------------------------------
    # Ensure all modules are tidy (multi-module mode only)
    # Handles both go.work workspaces and single-module repos with multi-module testing enabled
    # --------------------------------------------------------------------
    - name: üìã Ensure modules are tidy (multi-module)
      if: ${{ inputs.enable-multi-module == 'true' }}
      shell: bash
      run: |
        set -euo pipefail
        echo "üîß Multi-module mode - detecting workspace configuration"

        # Check if go.work exists (workspace mode)
        if [ -f "go.work" ]; then
          echo "üì¶ go.work workspace detected - syncing and tidying all modules"
          echo "‚ÑπÔ∏è  No root go.sum validation required (go.work manages workspace modules)"

          # Sync the workspace
          echo "üîÑ Running 'go work sync' to synchronize workspace modules..."
          go work sync

          # Find and tidy each module in the workspace
          echo "üîç Finding all modules in workspace..."
          module_paths=$(go work edit -json | jq -r '(.Use // [])[].DiskPath')
          if [ -z "$module_paths" ]; then
            echo "‚ùå Error: No modules found in workspace - go.work exists but has no 'use' directives"
            exit 1
          fi

          tidy_failed=0
          while read -r module_dir; do
            # Skip empty lines
            [ -n "$module_dir" ] || continue

            if [ ! -f "$module_dir/go.mod" ]; then
              echo "‚ùå Module directory $module_dir is missing go.mod file"
              exit 1
            fi
            echo "üîß Tidying module: $module_dir"
            if ! (cd "$module_dir" && go mod tidy); then
              echo "‚ùå Failed to tidy module: $module_dir"
              tidy_failed=1
            fi
          done <<< "$module_paths"

          if [ "$tidy_failed" -ne 0 ]; then
            echo "‚ùå One or more modules failed to tidy"
            exit 1
          fi

          echo "‚úÖ All workspace modules synced and tidied successfully"
        else
          # No go.work - single module with multi-module testing enabled
          echo "üìÅ No go.work file - running single module tidy from repository root"
          echo "‚ÑπÔ∏è  Multi-module testing mode without workspace (legacy behavior)"
          magex tidy
          echo "‚úÖ Module tidied successfully"
        fi

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # Ensure cache directories exist
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    - name: üìÅ Ensure cache directories exist
      shell: bash
      run: |
        echo "üìÅ Ensuring cache directories exist..."
        mkdir -p "$GOMODCACHE"
        mkdir -p "$GOCACHE"
        mkdir -p "$GOCACHE/test"
        echo "‚úÖ Cache directories created successfully"

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # Full checkout for module download (only when module cache misses)
    # The initial sparse checkout only includes go.mod/go.sum for cache key generation.
    # Module download requires full checkout because go.mod has replace directives
    # pointing to local sibling modules (e.g., ../functions/pkg/config).
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    - name: üì• Full checkout for module download (module cache miss)
      if: steps.setup-go.outputs.module-cache-hit != 'true'
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        persist-credentials: false

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # Download modules when module cache missed
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    - name: ‚¨áÔ∏è Download modules (module cache miss)
      if: steps.setup-go.outputs.module-cache-hit != 'true'
      shell: bash
      run: |
        set -euo pipefail
        GO_MODULE_DIR="${{ env.GO_MODULE_DIR }}"
        echo "‚¨áÔ∏è Module cache miss - downloading modules..."

        echo "============================================================"
        echo "=== Downloading Dependencies ==="
        echo "============================================================"

        if [ "$ENABLE_MULTI_MODULE_TESTING" == "true" ]; then
          echo "üîß Multi-module mode - running magex deps:download from repository root"
          echo "üì¶ magex will discover all Go modules and download dependencies"
          magex deps:download
        elif [ -n "$GO_MODULE_DIR" ]; then
          echo "üîß Running magex deps:download from directory: $GO_MODULE_DIR"
          (cd "$GO_MODULE_DIR" && magex deps:download)
        else
          echo "üîß Running magex deps:download from repository root"
          magex deps:download
        fi
        echo "‚úÖ Modules downloaded successfully"

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # Full checkout for build cache warming (only when module cache hit but build missed)
    # If module cache missed, we already did a full checkout above.
    # This handles the case where module cache was warm but build cache needs warming.
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    - name: üì• Full checkout for build warming (module hit, build miss)
      if: steps.setup-go.outputs.module-cache-hit == 'true' && steps.setup-go.outputs.build-cache-hit != 'true'
      uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
      with:
        persist-credentials: false

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # Warm build cache when build cache missed
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    - name: üèóÔ∏è Warm build cache (build cache miss)
      if: steps.setup-go.outputs.build-cache-hit != 'true'
      shell: bash
      run: |
        set -euo pipefail
        GO_MODULE_DIR="${{ env.GO_MODULE_DIR }}"
        echo "üîß Build cache miss - pre-building packages..."

        echo "============================================================"
        echo "=== Pre-building Packages ==="
        echo "============================================================"

        # Use MAGE_X_PARALLEL from env if set, otherwise default to 1 for memory safety
        PARALLEL_JOBS="${MAGE_X_PARALLEL:-1}"
        echo "üîß Using parallelism level: $PARALLEL_JOBS (from MAGE_X_PARALLEL env var)"

        if [ "$ENABLE_MULTI_MODULE_TESTING" == "true" ]; then
          echo "üîß Multi-module mode - running build commands from repository root"
          echo "üì¶ magex will discover all Go modules and pre-build packages"
          # Use configured parallelism to avoid OOM on GitHub Actions runners
          magex build:prebuild p="$PARALLEL_JOBS" strategy="${MAGE_X_BUILD_STRATEGY:-smart}" batch_size="${MAGE_X_BUILD_BATCH_SIZE:-20}" batch_delay="${MAGE_X_BUILD_BATCH_DELAY_MS:-0}" exclude="${MAGE_X_BUILD_EXCLUDE_PATTERN:-}"

          echo "üèóÔ∏è Building stdlib for host platform..."
          magex install:stdlib
        elif [ -n "$GO_MODULE_DIR" ]; then
          echo "üîß Running build commands from directory: $GO_MODULE_DIR"
          # Use configured parallelism to avoid OOM on GitHub Actions runners
          (cd "$GO_MODULE_DIR" && magex build:prebuild p="$PARALLEL_JOBS" strategy="${MAGE_X_BUILD_STRATEGY:-smart}" batch_size="${MAGE_X_BUILD_BATCH_SIZE:-20}" batch_delay="${MAGE_X_BUILD_BATCH_DELAY_MS:-0}" exclude="${MAGE_X_BUILD_EXCLUDE_PATTERN:-}")

          echo "üèóÔ∏è Building stdlib for host platform..."
          (cd "$GO_MODULE_DIR" && magex install:stdlib)
        else
          echo "üîß Running build commands from repository root"
          # Use configured parallelism to avoid OOM on GitHub Actions runners
          magex build:prebuild p="$PARALLEL_JOBS" strategy="${MAGE_X_BUILD_STRATEGY:-smart}" batch_size="${MAGE_X_BUILD_BATCH_SIZE:-20}" batch_delay="${MAGE_X_BUILD_BATCH_DELAY_MS:-0}" exclude="${MAGE_X_BUILD_EXCLUDE_PATTERN:-}"

          echo "üèóÔ∏è Building stdlib for host platform..."
          magex install:stdlib
        fi

        echo "‚úÖ Build cache warmed for Go ${{ inputs.go-version }}"

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # Save the build cache we just created
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    - name: üíæ Save Go build cache
      if: steps.setup-go.outputs.build-cache-hit != 'true'
      uses: actions/cache/save@5a3ec84eff668545956fd18022155c47e93e2684 # v4.0.2
      with:
        path: |
          ~/.cache/go-build
          ~/.cache/go-build/test
        key: ${{ steps.cache-keys.outputs.build-key }}

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # Save the Go module cache we just populated
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    - name: üíæ Save Go module cache
      if: steps.setup-go.outputs.module-cache-hit != 'true'
      uses: actions/cache/save@5a3ec84eff668545956fd18022155c47e93e2684 # v4.0.2
      with:
        path: ~/go/pkg/mod
        key: ${{ steps.cache-keys.outputs.module-key }}

    # --------------------------------------------------------------------
    # Track cache performance (no outputs - use artifacts instead)
    # --------------------------------------------------------------------
    - name: üìä Calculate cache statistics
      id: cache-summary
      if: always()
      shell: bash
      run: |
        STATS_FILE="cache-stats-${{ inputs.matrix-os }}-${{ inputs.go-version }}.json"

        # Redis cache statistics
        REDIS_ENABLED="${{ inputs.redis-enabled }}"
        REDIS_VERSIONS_WARMED="${{ steps.warm-redis.outputs.versions-warmed || '0' }}"
        REDIS_TOTAL_CACHE_SIZE="${{ steps.warm-redis.outputs.total-cache-size || '0' }}"
        REDIS_OPERATION_TIME="${{ steps.warm-redis.outputs.operation-time || '0' }}"
        REDIS_WARMING_STATUS="${{ steps.warm-redis.outputs.warming-status || 'disabled' }}"
        REDIS_CACHE_KEYS="${{ steps.warm-redis.outputs.cache-keys || '' }}"

        cat > "$STATS_FILE" << EOF
        {
          "os": "${{ inputs.matrix-os }}",
          "go_version": "${{ inputs.go-version }}",
          "gomod_cache_hit": ${{ steps.setup-go.outputs.module-cache-hit == 'true' && 'true' || 'false' }},
          "gobuild_cache_hit": ${{ steps.setup-go.outputs.build-cache-hit == 'true' && 'true' || 'false' }},
          "cache_size_gomod": "$(du -sh $GOMODCACHE 2>/dev/null | cut -f1 || echo '0')",
          "cache_size_gobuild": "$(du -sh $GOCACHE 2>/dev/null | cut -f1 || echo '0')",
          "redis_enabled": "$REDIS_ENABLED",
          "redis_versions_warmed": "$REDIS_VERSIONS_WARMED",
          "redis_cache_size_mb": "$REDIS_TOTAL_CACHE_SIZE",
          "redis_operation_time_s": "$REDIS_OPERATION_TIME",
          "redis_warming_status": "$REDIS_WARMING_STATUS",
          "redis_cache_keys": "$REDIS_CACHE_KEYS",
          "workflow": "cache-warm",
          "job_name": "warm-cache",
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
        }
        EOF

        echo "üìä Cache statistics:"
        jq . "$STATS_FILE"

        # Additional Redis warming report
        if [[ "$REDIS_ENABLED" == "true" ]]; then
          echo ""
          echo "üóÑÔ∏è Redis Cache Warming Summary:"
          echo "   ‚Ä¢ Versions Warmed: $REDIS_VERSIONS_WARMED"
          echo "   ‚Ä¢ Total Cache Size: ${REDIS_TOTAL_CACHE_SIZE}MB"
          echo "   ‚Ä¢ Operation Time: ${REDIS_OPERATION_TIME}s"
          echo "   ‚Ä¢ Status: $REDIS_WARMING_STATUS"
          if [[ -n "$REDIS_CACHE_KEYS" ]]; then
            echo "   ‚Ä¢ Cache Keys:"
            echo "$REDIS_CACHE_KEYS" | tr ',' '\n' | sed 's/^/     - /'
          fi
        fi

    # --------------------------------------------------------------------
    # Upload cache statistics
    # --------------------------------------------------------------------
    - name: üì§ Upload cache statistics
      if: always()
      uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
      with:
        name: cache-stats-${{ inputs.matrix-os }}-${{ inputs.go-version }}
        path: cache-stats-*.json
        retention-days: 1
