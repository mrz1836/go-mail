# ------------------------------------------------------------------------------------
#  Dependabot Auto-merge Workflow
#
#  Purpose: Automatically merge Dependabot updates based on configurable rules
#           for different update types (patch, minor, major) and dependency types
#           (development, production). Security updates get special handling.
#
#  Configuration: All settings are loaded from .env.base and .env.custom files for
#  centralized management across all workflows.
#
#  Triggers: Pull request events for immediate response to Dependabot PRs
#
#  Auto-merge Rules (configurable via .env.base/.env.custom):
#  - Patch updates: Auto-merge by default
#  - Minor dev dependencies: Auto-merge by default
#  - Minor prod dependencies: Manual review by default
#  - Major updates: Always require manual review with alert
#  - Security updates: Auto-merge non-major by default
#
#  Maintainer: @mrz1836
#
# ------------------------------------------------------------------------------------

name: Dependabot Auto-merge

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# Trigger Configuration
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

# Security: Restrictive default permissions with job-level overrides for least privilege access
permissions:
  contents: read

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# Concurrency Control
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# Environment Variables
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# Note: Configuration variables are loaded from .env.base and .env.custom files

jobs:
  # ----------------------------------------------------------------------------------
  # Load Environment Variables
  # ----------------------------------------------------------------------------------
  load-env:
    name: ğŸŒ Load Environment Variables
    runs-on: ubuntu-latest
    # Only run on Dependabot PRs
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    outputs:
      env-json: ${{ steps.load-env.outputs.env-json }}
    steps:
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Check out code to access env file
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ“¥ Checkout code (sparse)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          sparse-checkout: |
            .github/.env.base
            .github/.env.custom
            .github/actions/load-env

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Load and parse environment file
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸŒ Load environment variables
        uses: ./.github/actions/load-env
        id: load-env

  # ----------------------------------------------------------------------------------
  # Process Dependabot PR
  # ----------------------------------------------------------------------------------
  process-pr:
    name: ğŸ¤– Process Dependabot PR
    needs: [load-env]
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required for Dependabot PRs: Enables auto-merge (not needed for other PRs)
      pull-requests: write # Required: Update and merge Dependabot PRs
      issues: write # Required: Comment on related dependency issues
    outputs:
      dependency-names: ${{ steps.metadata.outputs.dependency-names }}
      update-type: ${{ steps.metadata.outputs.update-type }}
      dependency-type: ${{ steps.metadata.outputs.dependency-type }}
      action-taken: ${{ steps.determine-action.outputs.action }}

    steps:
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Extract configuration from env-json
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ”§ Extract configuration
        id: config
        env:
          ENV_JSON: ${{ needs.load-env.outputs.env-json }}
        run: |
          echo "ğŸ“‹ Extracting Dependabot configuration from environment..."

          # Extract all needed variables
          MAINTAINER=$(echo "$ENV_JSON" | jq -r '.DEPENDABOT_MAINTAINER_USERNAME')
          AUTO_MERGE_PATCH=$(echo "$ENV_JSON" | jq -r '.DEPENDABOT_AUTO_MERGE_PATCH')
          AUTO_MERGE_MINOR_DEV=$(echo "$ENV_JSON" | jq -r '.DEPENDABOT_AUTO_MERGE_MINOR_DEV')
          AUTO_MERGE_MINOR_PROD=$(echo "$ENV_JSON" | jq -r '.DEPENDABOT_AUTO_MERGE_MINOR_PROD')
          AUTO_MERGE_SECURITY=$(echo "$ENV_JSON" | jq -r '.DEPENDABOT_AUTO_MERGE_SECURITY_NON_MAJOR')
          ALERT_ON_MAJOR=$(echo "$ENV_JSON" | jq -r '.DEPENDABOT_ALERT_ON_MAJOR')
          ALERT_ON_MINOR_PROD=$(echo "$ENV_JSON" | jq -r '.DEPENDABOT_ALERT_ON_MINOR_PROD')
          MANUAL_REVIEW_LABEL=$(echo "$ENV_JSON" | jq -r '.DEPENDABOT_MANUAL_REVIEW_LABEL')
          AUTO_MERGE_LABELS=$(echo "$ENV_JSON" | jq -r '.DEPENDABOT_AUTO_MERGE_LABELS')
          PREFERRED_TOKEN=$(echo "$ENV_JSON" | jq -r '.PREFERRED_GITHUB_TOKEN')

          # Validate required configuration
          if [[ -z "$MAINTAINER" ]] || [[ "$MAINTAINER" == "null" ]]; then
            echo "âŒ ERROR: DEPENDABOT_MAINTAINER_USERNAME not set in configuration" >&2
            exit 1
          fi

          # Set as environment variables for all subsequent steps
          echo "MAINTAINER=$MAINTAINER" >> $GITHUB_ENV
          echo "AUTO_MERGE_PATCH=$AUTO_MERGE_PATCH" >> $GITHUB_ENV
          echo "AUTO_MERGE_MINOR_DEV=$AUTO_MERGE_MINOR_DEV" >> $GITHUB_ENV
          echo "AUTO_MERGE_MINOR_PROD=$AUTO_MERGE_MINOR_PROD" >> $GITHUB_ENV
          echo "AUTO_MERGE_SECURITY=$AUTO_MERGE_SECURITY" >> $GITHUB_ENV
          echo "ALERT_ON_MAJOR=$ALERT_ON_MAJOR" >> $GITHUB_ENV
          echo "ALERT_ON_MINOR_PROD=$ALERT_ON_MINOR_PROD" >> $GITHUB_ENV
          echo "MANUAL_REVIEW_LABEL=$MANUAL_REVIEW_LABEL" >> $GITHUB_ENV
          echo "AUTO_MERGE_LABELS=$AUTO_MERGE_LABELS" >> $GITHUB_ENV

          # Log configuration
          echo "ğŸ” Configuration loaded:"
          echo "  ğŸ‘¤ Maintainer: @$MAINTAINER"
          echo "  ğŸ”§ Auto-merge patch: $AUTO_MERGE_PATCH"
          echo "  ğŸ”§ Auto-merge minor dev: $AUTO_MERGE_MINOR_DEV"
          echo "  ğŸ”§ Auto-merge minor prod: $AUTO_MERGE_MINOR_PROD"
          echo "  ğŸ”’ Auto-merge security (non-major): $AUTO_MERGE_SECURITY"
          echo "  âš ï¸ Alert on major: $ALERT_ON_MAJOR"
          echo "  ğŸ” Alert on minor prod: $ALERT_ON_MINOR_PROD"
          echo "  ğŸ·ï¸ Manual review label: $MANUAL_REVIEW_LABEL"
          echo "  ğŸ·ï¸ Auto-merge labels: $AUTO_MERGE_LABELS"

          if [[ "$PREFERRED_TOKEN" == "GH_PAT_TOKEN" && -n "${{ secrets.GH_PAT_TOKEN }}" ]]; then
            echo "  ğŸ”‘ Token: Personal Access Token (PAT)"
          else
            echo "  ğŸ”‘ Token: Default GITHUB_TOKEN"
          fi

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Get official Dependabot metadata
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ“Š Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@08eff52bf64351f401fb50d4972fa95b9f2c2d1b # v2.4.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Log dependency information
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ“‹ Log dependency details
        run: |
          echo "ğŸ” Analyzing Dependabot PR #${{ github.event.pull_request.number }}..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Dependency: ${{ steps.metadata.outputs.dependency-names }}"
          echo "ğŸ”„ Update type: ${{ steps.metadata.outputs.update-type }}"
          echo "ğŸ“ Dependency type: ${{ steps.metadata.outputs.dependency-type }}"
          echo "ğŸŒ Package ecosystem: ${{ steps.metadata.outputs.package-ecosystem }}"
          echo "â¬†ï¸ Version: ${{ steps.metadata.outputs.previous-version }} â†’ ${{ steps.metadata.outputs.new-version }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Check if this is a security update
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ”’ Check for security update
        id: check-security
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_LABELS: ${{ join(github.event.pull_request.labels.*.name, ',') }}
        run: |
          echo "ğŸ”’ Checking if this is a security update..."

          # Check PR title and labels for security indicators
          # Using environment variables to prevent script injection
          if [[ "$PR_LABELS" == *"security"* ]] || \
             [[ "$PR_TITLE" == *"security"* ]] || \
             [[ "$PR_TITLE" == *"[Security]"* ]]; then
            echo "is_security=true" >> $GITHUB_OUTPUT
            echo "âœ… Security update detected"
          else
            echo "is_security=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Not a security update"
          fi

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Determine action based on configuration and update type
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ¯ Determine action
        id: determine-action
        run: |
          echo "ğŸ¯ Determining action based on update type and configuration..."

          UPDATE_TYPE="${{ steps.metadata.outputs.update-type }}"
          DEP_TYPE="${{ steps.metadata.outputs.dependency-type }}"
          IS_SECURITY="${{ steps.check-security.outputs.is_security }}"
          ACTION="none"

          # Security updates (if enabled)
          if [[ "$IS_SECURITY" == "true" ]] && [[ "${{ env.AUTO_MERGE_SECURITY }}" == "true" ]]; then
            if [[ "$UPDATE_TYPE" != "version-update:semver-major" ]]; then
              ACTION="auto-merge-security"
            else
              ACTION="alert-security-major"
            fi
          # Patch updates
          elif [[ "$UPDATE_TYPE" == "version-update:semver-patch" ]]; then
            if [[ "${{ env.AUTO_MERGE_PATCH }}" == "true" ]]; then
              ACTION="auto-merge-patch"
            else
              ACTION="manual-review"
            fi
          # Minor updates - development dependencies
          elif [[ "$UPDATE_TYPE" == "version-update:semver-minor" ]] && [[ "$DEP_TYPE" == "direct:development" ]]; then
            if [[ "${{ env.AUTO_MERGE_MINOR_DEV }}" == "true" ]]; then
              ACTION="auto-merge-minor-dev"
            else
              ACTION="manual-review"
            fi
          # Minor updates - production dependencies
          elif [[ "$UPDATE_TYPE" == "version-update:semver-minor" ]] && [[ "$DEP_TYPE" == "direct:production" ]]; then
            if [[ "${{ env.AUTO_MERGE_MINOR_PROD }}" == "true" ]]; then
              ACTION="auto-merge-minor-prod"
            elif [[ "${{ env.ALERT_ON_MINOR_PROD }}" == "true" ]]; then
              ACTION="alert-minor-prod"
            else
              ACTION="manual-review"
            fi
          # Major updates
          elif [[ "$UPDATE_TYPE" == "version-update:semver-major" ]]; then
            if [[ "${{ env.ALERT_ON_MAJOR }}" == "true" ]]; then
              ACTION="alert-major"
            else
              ACTION="manual-review"
            fi
          else
            ACTION="manual-review"
          fi

          echo "action=$ACTION" >> $GITHUB_OUTPUT
          echo "âœ… Determined action: $ACTION"

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Handle major version alerts
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: âš ï¸ Alert on major version bump
        if: steps.determine-action.outputs.action == 'alert-major' || steps.determine-action.outputs.action == 'alert-security-major'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.issue.number;
            const dependency = '${{ steps.metadata.outputs.dependency-names }}';
            const newVersion = '${{ steps.metadata.outputs.new-version }}';
            const previousVersion = '${{ steps.metadata.outputs.previous-version }}';
            const maintainer = '${{ env.MAINTAINER }}';
            const isSecurity = '${{ steps.check-security.outputs.is_security }}' === 'true';

            const emoji = isSecurity ? 'ğŸš¨' : 'âš ï¸';
            const prefix = isSecurity ? '**SECURITY** - ' : '';

            const commentBody = `${emoji} @${maintainer} â€“ ${prefix}**Major version update detected**

            **Dependency:** \`${dependency}\`
            **Version:** \`${previousVersion}\` â†’ \`${newVersion}\`
            **Type:** ${{ steps.metadata.outputs.dependency-type }}
            **Ecosystem:** ${{ steps.metadata.outputs.package-ecosystem }}
            ${isSecurity ? '\nğŸ”’ **This is a security update with potential breaking changes**' : ''}

            This requires manual review for potential breaking changes.

            **Review checklist:**
            - [ ] Check changelog/release notes for breaking changes
            - [ ] Review migration guide if available
            - [ ] Test functionality affected by this dependency
            - [ ] Update code if necessary to handle breaking changes`;

            // Check for existing alert comment to avoid duplicates
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              per_page: 100
            });

            const alertExists = comments.some(comment =>
              comment.body.includes('Major version update detected') &&
              comment.body.includes(dependency) &&
              comment.user.login === 'github-actions[bot]'
            );

            if (!alertExists) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: commentBody
              });

              // Add label for tracking
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['${{ env.MANUAL_REVIEW_LABEL }}']
              });
            } else {
              console.log('Major version alert already exists, skipping duplicate comment');
            }

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Handle minor production dependency alerts
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ” Alert on minor production dependency
        if: steps.determine-action.outputs.action == 'alert-minor-prod'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.issue.number;
            const dependency = '${{ steps.metadata.outputs.dependency-names }}';
            const newVersion = '${{ steps.metadata.outputs.new-version }}';
            const previousVersion = '${{ steps.metadata.outputs.previous-version }}';
            const maintainer = '${{ env.MAINTAINER }}';

            const commentBody = `ğŸ” @${maintainer} â€“ **Minor production dependency update**

            **Dependency:** \`${dependency}\`
            **Version:** \`${previousVersion}\` â†’ \`${newVersion}\`
            **Type:** Production dependency
            **Ecosystem:** ${{ steps.metadata.outputs.package-ecosystem }}

            Please review for potential feature changes or compatibility issues.

            **Quick review checklist:**
            - [ ] Check release notes for new features
            - [ ] Verify no deprecation warnings
            - [ ] Confirm compatibility with current code`;

            // Check for existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              per_page: 100
            });

            const commentExists = comments.some(comment =>
              comment.body.includes('Minor production dependency update') &&
              comment.body.includes(dependency) &&
              comment.user.login === 'github-actions[bot]'
            );

            if (!commentExists) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: commentBody
              });
            }

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Auto-merge approved updates
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸš€ Auto-merge approved updates
        if: |
          startsWith(steps.determine-action.outputs.action, 'auto-merge-')
        run: |
          echo "ğŸš€ Processing auto-merge for ${{ steps.determine-action.outputs.action }}..."

          ACTION="${{ steps.determine-action.outputs.action }}"
          DEPENDENCY="${{ steps.metadata.outputs.dependency-names }}"
          VERSION_CHANGE="${{ steps.metadata.outputs.previous-version }} â†’ ${{ steps.metadata.outputs.new-version }}"

          # Check token availability
          if [[ -n "${{ secrets.GH_PAT_TOKEN }}" ]]; then
            echo "ğŸ”‘ Using Personal Access Token for enhanced permissions"
            TOKEN_TYPE="PAT"
          else
            echo "âš ï¸ Using default GITHUB_TOKEN - auto-merge may fail for Dependabot PRs"
            TOKEN_TYPE="GITHUB_TOKEN"
          fi

          # Determine approval message based on action type
          case "$ACTION" in
            "auto-merge-patch")
              APPROVAL_MSG="âœ… Auto-approving patch update"
              ;;
            "auto-merge-minor-dev")
              APPROVAL_MSG="âœ… Auto-approving minor development dependency update"
              ;;
            "auto-merge-minor-prod")
              APPROVAL_MSG="âœ… Auto-approving minor production dependency update"
              ;;
            "auto-merge-security")
              APPROVAL_MSG="ğŸ”’ Auto-approving security update"
              ;;
            *)
              APPROVAL_MSG="âœ… Auto-approving dependency update"
              ;;
          esac

          # Approve the PR
          echo "ğŸ“ Approving PR..."
          if ! gh pr review --approve "$PR_URL" --body "$APPROVAL_MSG: $DEPENDENCY ($VERSION_CHANGE)"; then
            echo "âŒ Failed to approve PR"
            exit 1
          fi

          # Attempt to enable auto-merge
          echo "ğŸš€ Attempting to enable auto-merge..."
          if gh pr merge --auto --squash "$PR_URL"; then
            echo "âœ… Successfully enabled auto-merge for $ACTION"
          else
            echo "âš ï¸ Auto-merge failed (likely permissions issue)"
            echo "ğŸ’¡ Tip: Ensure GH_PAT_TOKEN is set with repo permissions for Dependabot PRs"

            # Fallback: Set up for manual merge
            echo "ğŸ”„ PR has been approved and is ready for manual merge"
            echo "action-taken=approved-ready-for-merge" >> $GITHUB_OUTPUT

            # Don't exit with error - the PR is still approved
          fi
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GH_PAT_TOKEN || secrets.GITHUB_TOKEN }}

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Add tracking labels
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ·ï¸ Add tracking labels
        if: |
          startsWith(steps.determine-action.outputs.action, 'auto-merge-') ||
          startsWith(steps.determine-action.outputs.action, 'alert-')
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const action = '${{ steps.determine-action.outputs.action }}';
            const labels = [];

            // Add auto-merge labels if applicable
            if (action.startsWith('auto-merge-')) {
              const autoMergeLabels = '${{ env.AUTO_MERGE_LABELS }}'.split(',').map(l => l.trim());
              labels.push(...autoMergeLabels);
            }

            // Add dependency type label
            const depType = '${{ steps.metadata.outputs.dependency-type }}';
            if (depType === 'direct:development') {
              labels.push('dev-dependency');
            } else if (depType === 'direct:production') {
              labels.push('prod-dependency');
            }

            // Add update type label
            const updateType = '${{ steps.metadata.outputs.update-type }}';
            if (updateType === 'version-update:semver-patch') {
              labels.push('patch-update');
            } else if (updateType === 'version-update:semver-minor') {
              labels.push('minor-update');
            } else if (updateType === 'version-update:semver-major') {
              labels.push('major-update');
            }

            // Add security label if applicable
            if ('${{ steps.check-security.outputs.is_security }}' === 'true') {
              labels.push('security');
            }

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
              console.log(`Added labels: ${labels.join(', ')}`);
            }

  # ----------------------------------------------------------------------------------
  # Generate Workflow Summary Report
  # ----------------------------------------------------------------------------------
  summary:
    name: ğŸ“Š Generate Summary
    if: always() && github.event.pull_request.user.login == 'dependabot[bot]'
    needs: [load-env, process-pr]
    runs-on: ubuntu-latest
    steps:
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Generate a workflow summary report
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ“Š Generate workflow summary
        env:
          ENV_JSON: ${{ needs.load-env.outputs.env-json }}
        run: |
          echo "ğŸ“Š Generating workflow summary..."

          echo "# ğŸ¤– Dependabot Auto-merge Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**â° Processed:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ“‹ PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ğŸ“¦ Dependency Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Dependency** | ${{ needs.process-pr.outputs.dependency-names }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Update Type** | ${{ needs.process-pr.outputs.update-type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Dependency Type** | ${{ needs.process-pr.outputs.dependency-type }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Determine action taken
          ACTION="${{ needs.process-pr.outputs.action-taken }}"
          case "$ACTION" in
            "auto-merge-patch")
              ACTION_DESC="âœ… Auto-merged (patch update)"
              ;;
            "auto-merge-minor-dev")
              ACTION_DESC="âœ… Auto-merged (minor dev dependency)"
              ;;
            "auto-merge-minor-prod")
              ACTION_DESC="âœ… Auto-merged (minor prod dependency)"
              ;;
            "auto-merge-security")
              ACTION_DESC="ğŸ”’ Auto-merged (security update)"
              ;;
            "approved-ready-for-merge")
              ACTION_DESC="âœ… Approved and ready for manual merge (auto-merge failed)"
              ;;
            "alert-major")
              ACTION_DESC="âš ï¸ Manual review required (major update)"
              ;;
            "alert-security-major")
              ACTION_DESC="ğŸš¨ Manual review required (major security update)"
              ;;
            "alert-minor-prod")
              ACTION_DESC="ğŸ” Manual review suggested (minor prod update)"
              ;;
            "manual-review")
              ACTION_DESC="ğŸ‘€ Manual review required"
              ;;
            *)
              ACTION_DESC="â“ Unknown action"
              ;;
          esac

          echo "## ğŸ¯ Action Taken" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$ACTION_DESC" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ğŸ”§ Current Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract configuration for display
          MAINTAINER=$(echo "$ENV_JSON" | jq -r '.DEPENDABOT_MAINTAINER_USERNAME')
          AUTO_MERGE_PATCH=$(echo "$ENV_JSON" | jq -r '.DEPENDABOT_AUTO_MERGE_PATCH')
          AUTO_MERGE_MINOR_DEV=$(echo "$ENV_JSON" | jq -r '.DEPENDABOT_AUTO_MERGE_MINOR_DEV')
          AUTO_MERGE_MINOR_PROD=$(echo "$ENV_JSON" | jq -r '.DEPENDABOT_AUTO_MERGE_MINOR_PROD')
          AUTO_MERGE_SECURITY=$(echo "$ENV_JSON" | jq -r '.DEPENDABOT_AUTO_MERGE_SECURITY_NON_MAJOR')

          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Auto-merge patch | $AUTO_MERGE_PATCH |" >> $GITHUB_STEP_SUMMARY
          echo "| Auto-merge minor dev | $AUTO_MERGE_MINOR_DEV |" >> $GITHUB_STEP_SUMMARY
          echo "| Auto-merge minor prod | $AUTO_MERGE_MINOR_PROD |" >> $GITHUB_STEP_SUMMARY
          echo "| Auto-merge security | $AUTO_MERGE_SECURITY |" >> $GITHUB_STEP_SUMMARY
          echo "| Maintainer | @$MAINTAINER |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ¤– _Automated by GitHub Actions_" >> $GITHUB_STEP_SUMMARY

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Report final workflow status
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ğŸ“¢ Report workflow status
        run: |
          echo "=== ğŸ¤– Dependabot Auto-merge Summary ==="
          echo "ğŸ“¦ Dependency: ${{ needs.process-pr.outputs.dependency-names }}"
          echo "ğŸ”„ Update type: ${{ needs.process-pr.outputs.update-type }}"
          echo "ğŸ“ Dependency type: ${{ needs.process-pr.outputs.dependency-type }}"

          ACTION="${{ needs.process-pr.outputs.action-taken }}"
          case "$ACTION" in
            auto-merge-*)
              echo "âœ… Action: Auto-merge enabled"
              ;;
            approved-ready-for-merge)
              echo "âœ… Action: Approved and ready for manual merge"
              ;;
            alert-*)
              echo "âš ï¸ Action: Alert sent, manual review required"
              ;;
            manual-review)
              echo "ğŸ‘€ Action: Manual review required"
              ;;
            *)
              echo "â“ Action: $ACTION"
              ;;
          esac

          echo "ğŸ• Completed: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "âœ… Workflow completed!"
