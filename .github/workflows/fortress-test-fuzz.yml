# ------------------------------------------------------------------------------------
#  Fuzz Testing (Reusable Workflow) (GoFortress)
#
#  Purpose: Execute Go fuzz tests to detect edge cases and potential security
#  vulnerabilities through automated input generation and testing.
#
#  This workflow handles:
#    - Fuzz test execution on primary runner with primary Go version
#    - Panic and error detection from fuzz test output
#    - Failure analysis and structured reporting
#    - Statistics collection and artifact uploading
#    - Cache performance tracking
#
#  Maintainer: @mrz1836
#
# ------------------------------------------------------------------------------------

name: GoFortress (Fuzz Tests)

on:
  workflow_call:
    inputs:
      env-json:
        description: "JSON string of environment variables"
        required: true
        type: string
      primary-runner:
        description: "Primary runner OS"
        required: true
        type: string
      go-primary-version:
        description: "Primary Go version"
        required: true
        type: string
      go-secondary-version:
        description: "Secondary Go version"
        required: true
        type: string
      fuzz-testing-enabled:
        description: "Whether fuzz testing is enabled"
        required: true
        type: string
      go-sum-file:
        description: "Path to go.sum file for dependency verification"
        required: true
        type: string

# Security: Restrictive default permissions with job-level overrides for least privilege access
permissions:
  contents: read

jobs:
  # ----------------------------------------------------------------------------------
  # Fuzz Testing
  # ----------------------------------------------------------------------------------
  fuzz-tests:
    name: ðŸ§ª Fuzz Tests
    if: inputs.fuzz-testing-enabled == 'true'
    timeout-minutes: 15 # Fuzz tests have shorter timeout
    permissions:
      contents: read # Read repository content for testing
    runs-on: ${{ inputs.primary-runner }}

    steps:
      # --------------------------------------------------------------------
      # Checkout code (required for local actions)
      # --------------------------------------------------------------------
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # --------------------------------------------------------------------
      # Parse environment variables
      # --------------------------------------------------------------------
      - name: ðŸ”§ Parse environment variables
        uses: ./.github/actions/parse-env
        with:
          env-json: ${{ inputs.env-json }}

      # --------------------------------------------------------------------
      # Setup Go with caching and version management (primary version only)
      # --------------------------------------------------------------------
      - name: ðŸ—ï¸ Setup Go with Cache
        id: setup-go-fuzz
        uses: ./.github/actions/setup-go-with-cache
        with:
          go-version: ${{ inputs.go-primary-version }}
          matrix-os: ${{ inputs.primary-runner }}
          go-primary-version: ${{ inputs.go-primary-version }}
          go-secondary-version: ${{ inputs.go-secondary-version }}
          go-sum-file: ${{ inputs.go-sum-file }}
          enable-multi-module: ${{ env.ENABLE_MULTI_MODULE_TESTING }}

      # --------------------------------------------------------------------
      # Extract Go module directory from GO_SUM_FILE path
      # --------------------------------------------------------------------
      - name: ðŸ”§ Extract Go module directory
        uses: ./.github/actions/extract-module-dir
        with:
          go-sum-file: ${{ inputs.go-sum-file }}

      # --------------------------------------------------------------------
      # Setup MAGE-X (required for magex test commands)
      # --------------------------------------------------------------------
      - name: ðŸ”§ Setup MAGE-X
        uses: ./.github/actions/setup-magex
        with:
          magex-version: ${{ env.MAGE_X_VERSION }}
          runner-os: ${{ inputs.primary-runner }}
          use-local: ${{ env.MAGE_X_USE_LOCAL }}

      # --------------------------------------------------------------------
      # Start fuzz test timer
      # --------------------------------------------------------------------
      - name: â±ï¸ Start fuzz test timer
        id: fuzz-timer
        run: |
          echo "fuzz-start=$(date +%s)" >> $GITHUB_OUTPUT
          echo "ðŸ•’ Fuzz test timer started at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

      # --------------------------------------------------------------------
      # Run fuzz tests
      # --------------------------------------------------------------------
      - name: ðŸ§ª Run fuzz tests
        id: run-fuzz-tests
        continue-on-error: true
        run: |
          echo "ðŸ§ª Running fuzz tests in parallel..."
          FUZZ_TIMEOUT="${TEST_TIMEOUT_FUZZ:-5m}"
          GO_MODULE_DIR="${{ env.GO_MODULE_DIR }}"

          if [ -n "$GO_MODULE_DIR" ]; then
            echo "ðŸ”§ Running magex test:fuzz from directory: $GO_MODULE_DIR"
            (cd "$GO_MODULE_DIR" && magex test:fuzz time=5s -timeout $FUZZ_TIMEOUT) 2>&1 | tee fuzz-output.log
          else
            echo "ðŸ”§ Running magex test:fuzz from repository root"
            magex test:fuzz time=5s -timeout $FUZZ_TIMEOUT 2>&1 | tee fuzz-output.log
          fi

          FUZZ_EXIT_CODE=${PIPESTATUS[0]}
          echo "ðŸ”§ Fuzz tests completed with timeout: $FUZZ_TIMEOUT"

          # Store the exit code for later steps
          echo "FUZZ_EXIT_CODE=$FUZZ_EXIT_CODE" >> $GITHUB_ENV
          echo "fuzz-exit-code=$FUZZ_EXIT_CODE" >> $GITHUB_OUTPUT

          if [[ $FUZZ_EXIT_CODE -eq 0 ]]; then
            echo "âœ… Fuzz tests completed successfully"
          else
            echo "âŒ Fuzz tests failed with exit code $FUZZ_EXIT_CODE"
          fi

      # --------------------------------------------------------------------
      # Fuzz test failure analysis and reporting (using magex CI mode JSONL output)
      # --------------------------------------------------------------------
      - name: ðŸš¨ Create Fuzz Test Failure Summary
        if: failure()
        run: |
          echo "## ðŸš¨ Fuzz Test Failures" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **OS**: ${{ inputs.primary-runner }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Go Version**: ${{ inputs.go-primary-version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Use magex CI mode JSONL output if available
          JSONL_FILE=".mage-x/ci-results-fuzz.jsonl"
          if [ -f "$JSONL_FILE" ]; then
            FAIL_COUNT=$(grep -c '"type":"failure"' "$JSONL_FILE" 2>/dev/null || echo "0")
            echo "- **Failed Fuzz Tests**: $FAIL_COUNT" >> $GITHUB_STEP_SUMMARY

            if [ "$FAIL_COUNT" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ” Failed Fuzz Tests" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep '"type":"failure"' "$JSONL_FILE" | head -5 | jq -r '.failure.test + " - " + (.failure.error // "test failed")' >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          elif [ -f fuzz-output.log ]; then
            # Fallback to log file parsing
            FAIL_COUNT=$(grep -c -E "^--- FAIL:" fuzz-output.log 2>/dev/null || echo "0")
            echo "- **Failed Fuzz Tests**: $FAIL_COUNT" >> $GITHUB_STEP_SUMMARY

            if [ "$FAIL_COUNT" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ” Failed Fuzz Tests" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -E "^--- FAIL:" fuzz-output.log | head -5 >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No fuzz test output found" >> $GITHUB_STEP_SUMMARY
          fi

      # --------------------------------------------------------------------
      # Create GitHub annotations for fuzz test failures
      # --------------------------------------------------------------------
      - name: ðŸ“‹ Annotate Key Fuzz Test Failures
        if: failure()
        run: |
          # Use magex CI mode JSONL output if available
          JSONL_FILE=".mage-x/ci-results-fuzz.jsonl"
          if [ -f "$JSONL_FILE" ]; then
            FAIL_COUNT=$(grep -c '"type":"failure"' "$JSONL_FILE" 2>/dev/null || echo "0")
            echo "::error title=Fuzz Test Suite Failed::$FAIL_COUNT fuzz tests failed on ${{ inputs.primary-runner }} Go ${{ inputs.go-primary-version }}"

            # Annotate first 3 failures from JSONL
            if [ "$FAIL_COUNT" -gt 0 ]; then
              grep '"type":"failure"' "$JSONL_FILE" | head -3 | while read -r line; do
                TEST=$(echo "$line" | jq -r '.failure.test')
                ERROR=$(echo "$line" | jq -r '.failure.error // "test failed"')
                echo "::error title=Failed Fuzz Test::$TEST - $ERROR"
              done
            fi
          elif [ -f fuzz-output.log ]; then
            # Fallback to log file parsing
            FAIL_COUNT=$(grep -c -E "^--- FAIL:" fuzz-output.log 2>/dev/null || echo "0")
            echo "::error title=Fuzz Test Suite Failed::$FAIL_COUNT fuzz tests failed on ${{ inputs.primary-runner }} Go ${{ inputs.go-primary-version }}"

            if [ "$FAIL_COUNT" -gt 0 ]; then
              grep -E "^--- FAIL:" fuzz-output.log | head -3 | while read -r line; do
                echo "::error title=Failed Fuzz Test::$line"
              done
            fi
          fi

      # --------------------------------------------------------------------
      # Generate fuzz test statistics using composite action
      # --------------------------------------------------------------------
      - name: ðŸ“Š Calculate fuzz test statistics
        id: fuzz-summary
        if: always()
        uses: ./.github/actions/test-statistics
        with:
          matrix-name: "Fuzz Tests (${{ inputs.primary-runner }})"
          matrix-os: ${{ inputs.primary-runner }}
          matrix-go-version: ${{ inputs.go-primary-version }}
          test-exit-code: ${{ steps.run-fuzz-tests.outputs.fuzz-exit-code || '0' }}
          output-mode: "FULL"
          job-status: ${{ job.status }}
          test-start-time: ${{ steps.fuzz-timer.outputs.fuzz-start || '0' }}
          race-detection-enabled: "false"
          code-coverage-enabled: "false"
          fuzz-run: "true"
          failures-file: "fuzz-failures.txt"
          output-file: "fuzz-output.log"

      # --------------------------------------------------------------------
      # Collect performance cache statistics
      # --------------------------------------------------------------------
      - name: ðŸ“Š Collect performance cache statistics
        uses: ./.github/actions/collect-cache-stats
        with:
          workflow-name: fuzz
          job-name: fuzz-tests
          os: ${{ inputs.primary-runner }}
          go-version: ${{ inputs.go-primary-version }}
          cache-prefix: cache-stats
          gomod-cache-hit: ${{ steps.setup-go-fuzz.outputs.module-cache-hit }}
          gobuild-cache-hit: ${{ steps.setup-go-fuzz.outputs.build-cache-hit }}

      # --------------------------------------------------------------------
      # Upload performance cache statistics for completion report
      # --------------------------------------------------------------------
      - name: ðŸ“¤ Upload performance cache statistics
        if: always()
        uses: ./.github/actions/upload-statistics
        with:
          artifact-name: cache-stats-fuzz
          artifact-path: cache-stats-fuzz.json
          retention-days: "1"

      # --------------------------------------------------------------------
      # Upload fuzz test outputs and failures for validation
      # --------------------------------------------------------------------
      - name: ðŸ“¤ Upload fuzz test outputs
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: test-results-fuzz-${{ inputs.primary-runner }}-${{ inputs.go-primary-version }}
          path: |
            .mage-x/ci-results-fuzz.jsonl
            fuzz-output.log
          retention-days: 1
          if-no-files-found: ignore
