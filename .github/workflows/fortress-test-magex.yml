# ------------------------------------------------------------------------------------
#  Test MAGE-X (Reusable Workflow) (GoFortress)
#
#  Purpose: Verify that MAGE-X is installed and working correctly with standard
#  magex commands. This is a prerequisite for other workflows that use magex commands.
#
#  Maintainer: @mrz1836
#
# ------------------------------------------------------------------------------------

name: GoFortress (Test MAGE-X)

on:
  workflow_call:
    inputs:
      env-json:
        description: "JSON string of environment variables"
        required: true
        type: string
      primary-runner:
        description: "Primary runner OS"
        required: true
        type: string

# Security: Restrictive default permissions with job-level overrides for least privilege access
permissions:
  contents: read

jobs:
  # ----------------------------------------------------------------------------------
  # Test MAGE-X (Installation and Command Verification)
  # ----------------------------------------------------------------------------------
  test-magex:
    name: ðŸª„ Verify & Test MAGE-X
    runs-on: ${{ inputs.primary-runner }}
    steps:
      # --------------------------------------------------------------------
      # Parse environment variables
      # --------------------------------------------------------------------
      - name: ðŸ”§ Parse environment variables
        env:
          ENV_JSON: ${{ inputs.env-json }}
        run: |
          echo "ðŸ“‹ Setting environment variables..."
          echo "$ENV_JSON" | jq -r 'to_entries | .[] | "\(.key)=\(.value)"' | while IFS='=' read -r key value; do
            echo "$key=$value" >> $GITHUB_ENV
          done

      # --------------------------------------------------------------------
      # Checkout code (conditional: full or sparse based on MAGE_X_USE_LOCAL)
      # --------------------------------------------------------------------
      # Full checkout when using local build (needs cmd/magex directory)
      - name: ðŸ“¥ Checkout (full - local build)
        if: env.MAGE_X_USE_LOCAL == 'true'
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0

      # Sparse checkout when using remote build (optimization)
      - name: ðŸ“¥ Checkout (sparse - remote build)
        if: env.MAGE_X_USE_LOCAL == 'false'
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0 # Required for sparse checkout
          sparse-checkout: |
            .github/.env.base
            .github/actions/setup-magex
            .mage.yaml
            go.mod
            ${{ env.GO_SUM_FILE }}

      # --------------------------------------------------------------------
      # Setup MAGE-X using the reusable composite action
      # --------------------------------------------------------------------
      - name: ðŸ”§ Setup MAGE-X
        id: setup-magex
        uses: ./.github/actions/setup-magex
        with:
          magex-version: ${{ env.MAGE_X_VERSION }}
          runner-os: ${{ inputs.primary-runner }}
          use-local: ${{ env.MAGE_X_USE_LOCAL }}

      # --------------------------------------------------------------------
      # Validate MAGE-X version matches requested version
      # --------------------------------------------------------------------
      - name: ðŸ” Validate MAGE-X Version
        id: validate-version
        run: |
          echo "ðŸ” Validating MAGE-X version..."

          # Get the actual version from the binary
          ACTUAL_VERSION=$(magex --version 2>/dev/null | grep -E '^\s+Version:' | awk '{print $2}' || echo "unknown")
          REQUESTED_VERSION="${{ env.MAGE_X_VERSION }}"
          USE_LOCAL="${{ env.MAGE_X_USE_LOCAL }}"

          echo "ðŸ“‹ Build mode: $([ "$USE_LOCAL" == "true" ] && echo "local (development)" || echo "remote (release)")"
          echo "ðŸ“‹ Requested version: $REQUESTED_VERSION"
          echo "ðŸ“‹ Actual version: $ACTUAL_VERSION"

          if [[ "$ACTUAL_VERSION" == "unknown" ]]; then
            echo "âŒ Failed: Could not determine magex version from binary"
            echo "âŒ This indicates a problem with version detection or binary corruption"
            echo "validation-result=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Local builds should have "dev" version
          if [[ "$USE_LOCAL" == "true" ]]; then
            if [[ "$ACTUAL_VERSION" == "dev" ]]; then
              echo "âœ… Version validation passed: local build has expected 'dev' version"
              echo "validation-result=success" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸  Warning: Local build has version '$ACTUAL_VERSION', expected 'dev'"
              echo "âš ï¸  This might indicate the version file hasn't been updated"
              echo "âœ… Accepting anyway since this is a local development build"
              echo "validation-result=success-with-warning" >> $GITHUB_OUTPUT
            fi
          else
            # Remote builds should match the requested version
            REQUESTED_CLEAN=$(echo "$REQUESTED_VERSION" | sed 's/^v//')
            ACTUAL_CLEAN=$(echo "$ACTUAL_VERSION" | sed 's/^v//')

            if [[ "$ACTUAL_CLEAN" == "$REQUESTED_CLEAN" ]]; then
              echo "âœ… Version validation passed: $ACTUAL_VERSION matches $REQUESTED_VERSION"
              echo "validation-result=success" >> $GITHUB_OUTPUT
            else
              echo "âŒ Version mismatch detected!"
              echo "âŒ Requested: $REQUESTED_VERSION (clean: $REQUESTED_CLEAN)"
              echo "âŒ Actual: $ACTUAL_VERSION (clean: $ACTUAL_CLEAN)"
              echo "âŒ This indicates a cache corruption or installation failure"
              echo "validation-result=failed" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      # --------------------------------------------------------------------
      # Verify MAGE-X installation and required commands
      # --------------------------------------------------------------------
      - name: âœ… Verify magex help and required commands
        id: verify-magex
        run: |
          echo "ðŸ“‹ Testing for required magex commands..."

          # Capture help output
          HELP_OUTPUT=$(magex help)

          echo "$HELP_OUTPUT"

          # List of required magex commands
          REQUIRED_COMMANDS=(
            "bench"
            "clean"
            "deps:download"
            "deps:update"
            "format:fix"
            "lint"
            "metrics:coverage"
            "metrics:loc"
            "release"
            "release:validate"
            "test"
            "test:cover"
            "test:coverrace"
            "test:fuzz"
            "test:race"
            "tidy"
            "update:install"
            "version:bump"
            "vet"
          )

          MATCHED_COUNT=0
          MISSING_COUNT=0
          MISSING_COMMANDS=()

          echo ""
          echo "ðŸ” Verifying required magex commands..."

          for cmd in "${REQUIRED_COMMANDS[@]}"; do
            if echo "$HELP_OUTPUT" | grep -qE "^[[:space:]]*$cmd[[:space:]]"; then
              echo "âœ… Found: $cmd"
              MATCHED_COUNT=$((MATCHED_COUNT + 1))
            else
              echo "âŒ Missing required command: $cmd"
              MISSING_COMMANDS+=("$cmd")
              MISSING_COUNT=$((MISSING_COUNT + 1))
            fi
          done

          echo ""
          echo "âœ… Matched: $MATCHED_COUNT"
          echo "âŒ Missing: $MISSING_COUNT"

          echo "matched=$MATCHED_COUNT" >> "$GITHUB_OUTPUT"
          echo "missing=$MISSING_COUNT" >> "$GITHUB_OUTPUT"
          echo "missing_commands=${MISSING_COMMANDS[*]}" >> "$GITHUB_OUTPUT"

          # Fail if anything is missing
          if [ $MISSING_COUNT -gt 0 ]; then
            echo ""
            echo "ðŸš¨ Missing MAGE-X commands:"
            printf ' - %s\n' "${MISSING_COMMANDS[@]}"
            exit 1
          fi

          echo ""
          echo "âœ… MAGE-X verification completed successfully."

      # --------------------------------------------------------------------
      # Summary of MAGE-X verification
      # --------------------------------------------------------------------
      - name: ðŸ“Š Job Summary
        run: |
          # Get magex version
          MAGEX_VERSION=$(magex --version 2>/dev/null | grep -E '^\s+Version:' | awk '{print $2}' || echo "unknown")

          echo "## ðŸª„ MAGE-X Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Verification Details | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| **Test** | magex help command |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | $MAGEX_VERSION |" >> $GITHUB_STEP_SUMMARY
          echo "| **Version Validation** | ${{ steps.validate-version.outputs.validation-result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Installation** | ${{ steps.setup-magex.outputs.installation-method == 'cached' && 'ðŸ’¾ From cache' || 'ðŸ“¥ Fresh install' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Purpose** | Verify MAGE-X installation and standard commands |" >> $GITHUB_STEP_SUMMARY
          echo "| **Matched Commands** | ${{ steps.verify-magex.outputs.matched }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Missing Commands** | ${{ steps.verify-magex.outputs.missing }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.verify-magex.outputs.missing }}" != "0" ]]; then
            echo "ðŸš¨ **Missing Commands:** ${{ steps.verify-magex.outputs.missing_commands }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸŽ¯ **MAGE-X is properly configured and functional.**" >> $GITHUB_STEP_SUMMARY
          fi
