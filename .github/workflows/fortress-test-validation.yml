# ------------------------------------------------------------------------------------
#  Test Results Validation (Reusable Workflow) (GoFortress)
#
#  Purpose: Validate and aggregate test results from all test workflows using
#  native CI mode output (.mage-x/ci-results.jsonl).
#
#  This workflow handles:
#    - Downloading CI results artifacts from test workflows
#    - Validating test exit codes and failure counts
#    - Aggregating failures across matrix jobs
#    - Creating comprehensive validation reports
#
#  CI Mode Integration: magex CI mode produces .mage-x/ci-results.jsonl which
#  contains structured failure data with built-in deduplication.
#
#  Maintainer: @mrz1836
#
# ------------------------------------------------------------------------------------

name: GoFortress (Test Validation)

on:
  workflow_call:
    inputs:
      env-json:
        description: "JSON string of environment variables"
        required: true
        type: string
      primary-runner:
        description: "Primary runner OS"
        required: true
        type: string
      fuzz-testing-enabled:
        description: "Whether fuzz testing is enabled"
        required: true
        type: string

# Security: Restrictive default permissions with job-level overrides for least privilege access
permissions:
  contents: read
  actions: read # Required for artifact downloads

jobs:
  # ----------------------------------------------------------------------------------
  # Validate Test Results
  # ----------------------------------------------------------------------------------
  validate-test-results:
    name: üîç Validate Test Results
    if: always() # Always run to check results even if jobs continued on error
    permissions:
      contents: read # Read repository content for validation
      actions: read # Read workflow artifacts for download
    runs-on: ${{ inputs.primary-runner }}

    steps:
      # --------------------------------------------------------------------
      # Checkout code (required for local actions)
      # --------------------------------------------------------------------
      - name: üì• Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # --------------------------------------------------------------------
      # Parse environment variables
      # --------------------------------------------------------------------
      - name: üîß Parse environment variables
        uses: ./.github/actions/parse-env
        with:
          env-json: ${{ inputs.env-json }}

      # --------------------------------------------------------------------
      # Download CI results from test matrix
      # --------------------------------------------------------------------
      - name: üì• Download CI results
        uses: ./.github/actions/download-artifact-resilient
        with:
          pattern: "ci-results-*"
          path: ci-results/
          merge-multiple: true
          max-retries: ${{ env.ARTIFACT_DOWNLOAD_RETRIES }}
          retry-delay: ${{ env.ARTIFACT_DOWNLOAD_RETRY_DELAY }}
          timeout: ${{ env.ARTIFACT_DOWNLOAD_TIMEOUT }}
          continue-on-error: ${{ env.ARTIFACT_DOWNLOAD_CONTINUE_ON_ERROR }}

      # --------------------------------------------------------------------
      # Download fuzz test results if enabled
      # --------------------------------------------------------------------
      - name: üì• Download fuzz test results
        if: inputs.fuzz-testing-enabled == 'true'
        uses: ./.github/actions/download-artifact-resilient
        with:
          pattern: "test-results-fuzz-*"
          path: ci-results/
          merge-multiple: true
          max-retries: ${{ env.ARTIFACT_DOWNLOAD_RETRIES }}
          retry-delay: ${{ env.ARTIFACT_DOWNLOAD_RETRY_DELAY }}
          timeout: ${{ env.ARTIFACT_DOWNLOAD_TIMEOUT }}
          continue-on-error: ${{ env.ARTIFACT_DOWNLOAD_CONTINUE_ON_ERROR }}

      # --------------------------------------------------------------------
      # Validate test results from CI mode JSONL output
      # --------------------------------------------------------------------
      - name: üîç Validate test results
        run: |
          echo "üîç Validating test results from CI mode output..."
          source .github/scripts/parse-test-label.sh

          VALIDATION_FAILED=false
          TOTAL_FAILURES=0
          TOTAL_UNIQUE=0
          TOTAL_TESTS=0
          TOTAL_SKIPPED=0

          # Find all CI results files
          echo "üìã Looking for CI results files..."
          find ci-results/ -name "ci-results.jsonl" -o -name "*.jsonl" 2>/dev/null | head -20

          # Process each CI results file
          # Note: Using find for recursive directory traversal to locate all matching files
          if find ci-results/ -name "*.jsonl" 2>/dev/null | grep -q .; then
            echo "‚úÖ Found CI results JSONL files"

            while IFS= read -r -d '' jsonl_file; do
              # Extract artifact directory name from JSONL file path
              # Supported directory structures:
              #   1. Expected: ci-results/ARTIFACT_NAME/.mage-x/ci-results.jsonl
              #      ‚Üí Use grandparent (skip .mage-x) to get ARTIFACT_NAME
              #   2. Fallback: ci-results/ARTIFACT_NAME/ci-results.jsonl
              #      ‚Üí Use parent directory as ARTIFACT_NAME
              ARTIFACT_DIR=$(dirname "$(dirname "$jsonl_file")" | xargs basename)
              JSONL_NAME=$(basename "$jsonl_file")

              # Detect which structure we have by checking parent directory
              PARENT_DIR=$(basename "$(dirname "$jsonl_file")")
              if [[ "$PARENT_DIR" != ".mage-x" ]]; then
                echo "  Warning: Unexpected artifact structure for: $jsonl_file"
                echo "  Expected: ci-results/ARTIFACT_NAME/.mage-x/ci-results.jsonl"
                # Fallback: parent is the artifact dir (not grandparent)
                ARTIFACT_DIR=$(basename "$(dirname "$jsonl_file")")
              fi

              TEST_LABEL=$(parse_test_label "$ARTIFACT_DIR" "$JSONL_NAME")

              echo ""
              echo "üìÑ Processing: $TEST_LABEL"

              # Extract summary line (type: summary)
              SUMMARY=$(grep '"type":"summary"' "$jsonl_file" 2>/dev/null | head -1 || echo "")

              if [[ -n "$SUMMARY" ]]; then
                # Parse summary data
                STATUS=$(echo "$SUMMARY" | jq -r '.summary.status // "unknown"')
                PASSED=$(echo "$SUMMARY" | jq -r '.summary.passed // 0')
                FAILED=$(echo "$SUMMARY" | jq -r '.summary.failed // 0')
                SKIPPED=$(echo "$SUMMARY" | jq -r '.summary.skipped // 0')
                UNIQUE=$(echo "$SUMMARY" | jq -r '.summary.unique_total // 0')
                TOTAL=$(echo "$SUMMARY" | jq -r '.summary.total // 0')
                DURATION=$(echo "$SUMMARY" | jq -r '.summary.duration // "unknown"')

                echo "  ‚Ä¢ Status: $STATUS"
                echo "  ‚Ä¢ Passed: $PASSED"
                echo "  ‚Ä¢ Failed: $FAILED"
                echo "  ‚Ä¢ Skipped: $SKIPPED"
                echo "  ‚Ä¢ Unique Tests: $UNIQUE"
                echo "  ‚Ä¢ Test Runs: $TOTAL"
                echo "  ‚Ä¢ Duration: $DURATION"

                TOTAL_UNIQUE=$((TOTAL_UNIQUE + UNIQUE))
                TOTAL_TESTS=$((TOTAL_TESTS + TOTAL))
                TOTAL_SKIPPED=$((TOTAL_SKIPPED + SKIPPED))

                if [[ "$STATUS" == "failed" ]] || [[ "$FAILED" -gt 0 ]]; then
                  VALIDATION_FAILED=true
                  TOTAL_FAILURES=$((TOTAL_FAILURES + FAILED))

                  # Extract failure details
                  echo ""
                  echo "  üö® Failures in this file:"
                  grep '"type":"failure"' "$jsonl_file" 2>/dev/null | while read -r line; do
                    TEST=$(echo "$line" | jq -r '.failure.test // "unknown"')
                    PKG=$(echo "$line" | jq -r '.failure.package // "unknown"' | sed 's|.*/||')
                    FILE=$(echo "$line" | jq -r '.failure.file // ""')
                    LINE_NUM=$(echo "$line" | jq -r '.failure.line // ""')
                    FAIL_TYPE=$(echo "$line" | jq -r '.failure.type // "test"')
                    ERROR_MSG=$(echo "$line" | jq -r '.failure.error // ""')

                    # Show test name with type and location
                    if [[ -n "$FILE" && -n "$LINE_NUM" && "$LINE_NUM" != "0" ]]; then
                      echo "    ‚ùå [$FAIL_TYPE] $TEST ($PKG) at $FILE:$LINE_NUM"
                    else
                      echo "    ‚ùå [$FAIL_TYPE] $TEST ($PKG)"
                    fi

                    # Show error message if available (truncated for readability)
                    if [[ -n "$ERROR_MSG" && "$ERROR_MSG" != "null" ]]; then
                      echo "       ‚Üí ${ERROR_MSG:0:200}"
                    fi
                  done | head -30
                fi
              else
                echo "  ‚ö†Ô∏è No summary found in JSONL file"

                # Try to count failures directly
                FAILURE_COUNT=$(grep -c '"type":"failure"' "$jsonl_file" 2>/dev/null || echo "0")
                if [[ "$FAILURE_COUNT" -gt 0 ]]; then
                  echo "  ‚Ä¢ Found $FAILURE_COUNT failure entries"
                  VALIDATION_FAILED=true
                  TOTAL_FAILURES=$((TOTAL_FAILURES + FAILURE_COUNT))
                fi
              fi
            done < <(find ci-results/ -name "*.jsonl" -print0 2>/dev/null)
          else
            echo "‚ö†Ô∏è No JSONL files found - checking for test-output.log files..."

            # Fallback: check test-output.log files for exit codes
            while IFS= read -r -d '' log_file; do
              echo "üìÑ Checking: $log_file"

              # Look for FAIL indicators
              if grep -q "^FAIL" "$log_file" 2>/dev/null || grep -q "--- FAIL:" "$log_file" 2>/dev/null; then
                echo "  ‚ùå Found test failures in log file"
                VALIDATION_FAILED=true
                FAIL_COUNT=$(grep -c "^--- FAIL:" "$log_file" 2>/dev/null || echo "1")
                TOTAL_FAILURES=$((TOTAL_FAILURES + FAIL_COUNT))
              fi
            done < <(find ci-results/ -name "test-output.log" -print0 2>/dev/null)
          fi

          # Final validation result
          echo ""
          echo "üèÅ Validation Summary:"
          echo "  ‚Ä¢ Unique Tests: $TOTAL_UNIQUE"
          echo "  ‚Ä¢ Test Runs: $TOTAL_TESTS"
          echo "  ‚Ä¢ Total Failures: $TOTAL_FAILURES"
          echo "  ‚Ä¢ Total Skipped: $TOTAL_SKIPPED"
          echo "  ‚Ä¢ Validation Status: $(if [[ "$VALIDATION_FAILED" == "true" ]]; then echo "FAILED"; else echo "PASSED"; fi)"

          if [[ "$VALIDATION_FAILED" == "true" ]]; then
            echo ""
            echo "‚ùå Test validation failed - $TOTAL_FAILURES failure(s) detected"
            echo "::error title=Test Validation Failed::$TOTAL_FAILURES test failure(s) detected. Check the CI results above for details."
            exit 1
          else
            echo ""
            echo "‚úÖ All tests passed validation"
          fi

      # --------------------------------------------------------------------
      # Create validation summary for GitHub UI
      # --------------------------------------------------------------------
      - name: üìä Create validation summary
        if: always()
        run: |
          source .github/scripts/parse-test-label.sh

          echo "## üîç Test Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count artifacts
          MATRIX_JOBS=$(find ci-results/ -name "*.jsonl" 2>/dev/null | wc -l || echo "0")
          echo "- **Matrix Jobs Validated**: $MATRIX_JOBS" >> $GITHUB_STEP_SUMMARY

          # Aggregate results from JSONL files
          TOTAL_PASSED=0
          TOTAL_FAILED=0
          TOTAL_SKIPPED=0
          TOTAL_UNIQUE=0
          TOTAL_TESTS=0

          while IFS= read -r -d '' jsonl_file; do
            SUMMARY=$(grep '"type":"summary"' "$jsonl_file" 2>/dev/null | head -1 || echo "")
            if [[ -n "$SUMMARY" ]]; then
              PASSED=$(echo "$SUMMARY" | jq -r '.summary.passed // 0')
              FAILED=$(echo "$SUMMARY" | jq -r '.summary.failed // 0')
              SKIPPED=$(echo "$SUMMARY" | jq -r '.summary.skipped // 0')
              UNIQUE=$(echo "$SUMMARY" | jq -r '.summary.unique_total // 0')
              TOTAL=$(echo "$SUMMARY" | jq -r '.summary.total // 0')
              TOTAL_PASSED=$((TOTAL_PASSED + PASSED))
              TOTAL_FAILED=$((TOTAL_FAILED + FAILED))
              TOTAL_SKIPPED=$((TOTAL_SKIPPED + SKIPPED))
              TOTAL_UNIQUE=$((TOTAL_UNIQUE + UNIQUE))
              TOTAL_TESTS=$((TOTAL_TESTS + TOTAL))
            fi
          done < <(find ci-results/ -name "*.jsonl" -print0 2>/dev/null)

          echo "- **Unique Tests**: $TOTAL_UNIQUE" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Runs**: $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed**: $TOTAL_PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- **Failed**: $TOTAL_FAILED" >> $GITHUB_STEP_SUMMARY
          echo "- **Skipped**: $TOTAL_SKIPPED" >> $GITHUB_STEP_SUMMARY
          echo "- **Validation Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ inputs.fuzz-testing-enabled }}" == "true" ]]; then
            echo "- **Fuzz Testing**: Enabled" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Show per-job breakdown
          if [[ $MATRIX_JOBS -gt 0 ]]; then
            echo "### Test Matrix Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            while IFS= read -r -d '' jsonl_file; do
              # Extract artifact directory name from JSONL file path
              # Supported directory structures:
              #   1. Expected: ci-results/ARTIFACT_NAME/.mage-x/ci-results.jsonl
              #      ‚Üí Use grandparent (skip .mage-x) to get ARTIFACT_NAME
              #   2. Fallback: ci-results/ARTIFACT_NAME/ci-results.jsonl
              #      ‚Üí Use parent directory as ARTIFACT_NAME
              ARTIFACT_DIR=$(dirname "$(dirname "$jsonl_file")" | xargs basename)
              JSONL_NAME=$(basename "$jsonl_file")

              # Detect which structure we have by checking parent directory
              PARENT_DIR=$(basename "$(dirname "$jsonl_file")")
              if [[ "$PARENT_DIR" != ".mage-x" ]]; then
                # Fallback: parent is the artifact dir (not grandparent)
                ARTIFACT_DIR=$(basename "$(dirname "$jsonl_file")")
              fi

              TEST_LABEL=$(parse_test_label "$ARTIFACT_DIR" "$JSONL_NAME")

              SUMMARY=$(grep '"type":"summary"' "$jsonl_file" 2>/dev/null | head -1 || echo "")

              if [[ -n "$SUMMARY" ]]; then
                STATUS=$(echo "$SUMMARY" | jq -r '.summary.status // "unknown"')
                PASSED=$(echo "$SUMMARY" | jq -r '.summary.passed // 0')
                FAILED=$(echo "$SUMMARY" | jq -r '.summary.failed // 0')

                if [[ "$STATUS" == "passed" ]]; then
                  echo "- ‚úÖ **$TEST_LABEL**: $PASSED tests passed" >> $GITHUB_STEP_SUMMARY
                else
                  echo "- ‚ùå **$TEST_LABEL**: $FAILED failures" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            done < <(find ci-results/ -name "*.jsonl" -print0 2>/dev/null)
          fi

          # Add detailed failure section if there are failures
          if [[ $TOTAL_FAILED -gt 0 ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üö® Failure Details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "_Expand each failure to see full output and stack traces_" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            FAILURE_COUNT=0
            while IFS= read -r -d '' jsonl_file; do
              while read -r line; do
                # Limit total failures shown
                FAILURE_COUNT=$((FAILURE_COUNT + 1))
                if [[ $FAILURE_COUNT -gt 20 ]]; then
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "_... additional failures truncated_" >> $GITHUB_STEP_SUMMARY
                  break 2
                fi

                TEST=$(echo "$line" | jq -r '.failure.test // "unknown"')
                PKG=$(echo "$line" | jq -r '.failure.package // "unknown"' | sed 's|.*/||')
                FAIL_TYPE=$(echo "$line" | jq -r '.failure.type // "test"')
                ERROR_MSG=$(echo "$line" | jq -r '.failure.error // ""')
                OUTPUT=$(echo "$line" | jq -r '.failure.output // ""')
                STACK=$(echo "$line" | jq -r '.failure.stack // ""')

                echo "<details>" >> $GITHUB_STEP_SUMMARY
                echo "<summary>‚ùå <code>$TEST</code> ($PKG) - $FAIL_TYPE</summary>" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY

                if [[ -n "$ERROR_MSG" && "$ERROR_MSG" != "null" ]]; then
                  echo "**Error:** \`$ERROR_MSG\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                fi

                if [[ -n "$OUTPUT" && "$OUTPUT" != "null" && "$OUTPUT" != "" ]]; then
                  echo "**Output:**" >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
                  # Truncate output to avoid massive summaries
                  echo "${OUTPUT:0:2000}" >> $GITHUB_STEP_SUMMARY
                  if [[ ${#OUTPUT} -gt 2000 ]]; then
                    echo "... (truncated)" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo '```' >> $GITHUB_STEP_SUMMARY
                fi

                if [[ -n "$STACK" && "$STACK" != "null" && "$STACK" != "" ]]; then
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Stack Trace:**" >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
                  echo "${STACK:0:1500}" >> $GITHUB_STEP_SUMMARY
                  if [[ ${#STACK} -gt 1500 ]]; then
                    echo "... (truncated)" >> $GITHUB_STEP_SUMMARY
                  fi
                  echo '```' >> $GITHUB_STEP_SUMMARY
                fi

                # For fuzz tests, show fuzz-specific info
                FUZZ_INFO=$(echo "$line" | jq -r '.failure.fuzz_info // null')
                if [[ "$FUZZ_INFO" != "null" && -n "$FUZZ_INFO" ]]; then
                  CORPUS=$(echo "$FUZZ_INFO" | jq -r '.corpus_path // ""')
                  if [[ -n "$CORPUS" && "$CORPUS" != "null" ]]; then
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "**Fuzz Corpus:** \`$CORPUS\`" >> $GITHUB_STEP_SUMMARY
                  fi
                fi

                echo "" >> $GITHUB_STEP_SUMMARY
                echo "</details>" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
              done < <(grep '"type":"failure"' "$jsonl_file" 2>/dev/null)
            done < <(find ci-results/ -name "*.jsonl" -print0 2>/dev/null)
          fi

      # --------------------------------------------------------------------
      # Upload validation artifacts
      # --------------------------------------------------------------------
      - name: üì§ Upload validation summary
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: validation-summary
          path: ci-results/
          retention-days: 1
          if-no-files-found: ignore
